name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact: video-stitcher-linux-x64
          - os: windows-latest
            platform: win32
            artifact: video-stitcher-win32-x64
          - os: macos-latest
            platform: darwin
            artifact: video-stitcher-darwin-arm64

    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          npm install
          cd frontend && npm install
          cd ../electron && npm install

      - name: Install Python dependencies and PyInstaller
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python backend executable
        shell: bash
        run: |
          cd backend
          
          # Determine path separator for --add-data (Windows uses ; Linux/Mac use :)
          if [[ "${{ matrix.platform }}" == "win32" ]]; then
            SEP=";"
          else
            SEP=":"
          fi
          
          pyinstaller --onedir --name backend_server \
            --paths=. \
            --add-data "data${SEP}data" \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.lifespan \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.lifespan.off \
            --hidden-import uvicorn.protocols \
            --hidden-import uvicorn.protocols.http \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.http.httptools_impl \
            --hidden-import uvicorn.protocols.websockets \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.websockets_impl \
            --hidden-import uvicorn.protocols.websockets.wsproto_impl \
            app/main.py
          ls -la dist/

      - name: Download FFmpeg
        run: npm run download-ffmpeg

      - name: Build frontend
        run: npm run frontend-build

      - name: Package Electron app
        run: npx electron-forge package

      - name: Copy backend bundle to packaged app
        shell: bash
        run: |
          # Determine the resources path based on platform
          if [ "${{ matrix.platform }}" == "darwin" ]; then
            RESOURCES_PATH="out/${{ matrix.artifact }}/Video Stitcher.app/Contents/Resources"
          else
            RESOURCES_PATH="out/${{ matrix.artifact }}/resources"
          fi
          
          # Copy PyInstaller bundle and FFmpeg to resources
          mkdir -p "$RESOURCES_PATH/dist_bundle"
          cp -r backend/dist/backend_server/* "$RESOURCES_PATH/dist_bundle/"
          
          # Copy FFmpeg binaries if they exist
          if [ -d "backend/bin" ]; then
            cp -r backend/bin "$RESOURCES_PATH/dist_bundle/"
          fi
          
          ls -la "$RESOURCES_PATH/dist_bundle/"

      - name: Clean up packaged app (remove source folders)
        shell: bash
        run: |
          # Determine the app path based on platform
          if [ "${{ matrix.platform }}" == "darwin" ]; then
            # macOS: find the actual app location
            RESOURCES_BASE="out/${{ matrix.artifact }}/Video Stitcher.app/Contents/Resources"
            echo "Looking for app in macOS bundle..."
            ls -la "$RESOURCES_BASE/" || true
            
            # The app could be directly in Resources or in Resources/app
            if [ -d "$RESOURCES_BASE/app" ]; then
              APP_PATH="$RESOURCES_BASE/app"
            else
              APP_PATH="$RESOURCES_BASE"
            fi
          else
            APP_PATH="out/${{ matrix.artifact }}/resources/app"
          fi
          
          echo "Cleaning up $APP_PATH..."
          
          # Only proceed if the path exists
          if [ -d "$APP_PATH" ]; then
            # Remove source folders that shouldn't be in the packaged app
            rm -rf "$APP_PATH/backend" || true
            rm -rf "$APP_PATH/frontend" || true
            rm -rf "$APP_PATH/scripts" || true
            rm -rf "$APP_PATH/docs" || true
            rm -rf "$APP_PATH/.git" || true
            rm -rf "$APP_PATH/.github" || true
            rm -rf "$APP_PATH/.vscode" || true
            rm -rf "$APP_PATH/node_modules" || true
            
            # Remove unnecessary files
            rm -f "$APP_PATH/.gitignore" || true
            rm -f "$APP_PATH/.gitattributes" || true
            rm -f "$APP_PATH/.prettierrc" || true
            rm -f "$APP_PATH/.prettierignore" || true
            rm -f "$APP_PATH/README.md" || true
            rm -f "$APP_PATH/LICENSE" || true
            
            echo "Contents after cleanup:"
            ls -la "$APP_PATH/" || true
            du -sh "$APP_PATH/" || true
          else
            echo "Warning: APP_PATH does not exist: $APP_PATH"
            echo "Listing out directory structure:"
            find out/${{ matrix.artifact }} -type d -maxdepth 5 | head -30
          fi

      - name: Create Linux wrapper script
        if: matrix.platform == 'linux'
        run: |
          cd out/${{ matrix.artifact }}
          mv video-stitcher video-stitcher.bin
          cat > video-stitcher << 'EOF'
          #!/bin/bash
          export ELECTRON_DISABLE_SANDBOX=1
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/video-stitcher.bin" "$@"
          EOF
          chmod +x video-stitcher

      - name: Compress artifact
        shell: bash
        run: |
          cd out
          if [ "${{ matrix.platform }}" == "win32" ]; then
            7z a -tzip ${{ matrix.artifact }}.zip ${{ matrix.artifact }}
          else
            tar -czvf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}
          fi
          ls -la

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: out/${{ matrix.artifact }}.*
          retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: ls -laR artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/video-stitcher-linux-x64/*
            artifacts/video-stitcher-win32-x64/*
            artifacts/video-stitcher-darwin-arm64/*
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
